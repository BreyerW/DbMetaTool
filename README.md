# DbMetaTool

Small CLI utility to build, export and update Firebird 5.x metadata.  
It can (1) create a new Firebird database file (using `isql`), (2) export metadata (domains, exceptions, tables, procedures) into a single `metadata.sql` file, and (3) apply update scripts to an existing database.

Features
- Build a new DB file (calls `isql` to create DB file then runs scripts via EF Core).
- Export domains, user exceptions, tables and stored procedures (procedures are wrapped with `SET TERM` and terminated with `^`).
- Exported table columns and procedure parameter/RETURN types prefer user domains when present; otherwise they fall back to concrete type mappings.
- Update an existing database by executing `.sql` files (uses the Firebird provider `FbScript` parsing when available).

Usage examples
- Build DB
  - `DbMetaTool build-db --db-dir "C:\db\fb5" --scripts-dir "C:\scripts"`
- Export metadata
  - `DbMetaTool export-scripts --connection-string "<conn>" --output-dir "C:\out"`
  - Output file: `metadata.sql` in `--output-dir`
- Update DB
  - `DbMetaTool update-db --connection-string "<conn>" --scripts-dir "C:\scripts"`

Installation
	- Install Firebird 5.0 server
	- Ensure `isql.exe` is accessible (set `ISQL_PATH` if needed)
	- Create user with necessary privileges for DB creation and updates. If you use username and/or password different from default (localuser), set `FB_SYS_USER` and `FB_SYS_PASS` environment variables.
		- One possible way is to create dummy (empty) database using `isql` or `IBExpert` and create user with `CREATE USER` statement followed with appropiate privilege grants (CREATE DOMAIN, CREATE TABLE, CREATE PROCEDURE).
	- Build from source using any IDE supporting .NET 8.0 SDK.
	- Open terminal, navigate to project directory and run one of `Usage examples`.
		- Included sample masterscript.sql generated with AI that can be used to test DB creation and updates. It's more complex than necessary (includes constraints, primary keys etc.) as such first export won't be mirror copy, but subsequent tests on outputted files should create exact copies.
		- Suggested order of operations:
			1. `build-db` with `masterscript.sql`
			2. `export-scripts` to get `metadata.sql`
			3. `update-db` on different db with `metadata.sql`
				- Note: if existing db already has same objects as exported db, `update-db` may fail due to object name conflicts. Failure will cause rollback attempt.
			4. Optionally repeat steps 1-2 on outputted `metadata.sql` and new db from previous steps to verify consistency.

Environment variables (used by the program)
- `ISQL_PATH` — Path to Firebird `isql.exe`. Default: `C:\Program Files\Firebird\Firebird_5_0\isql.exe`
- `FB_HOST` — Firebird host used for connection and DB creation. Default: `localhost`
- `FB_SYS_USER` — System user used when creating DB. Default: `localuser`
- `FB_SYS_PASS` — System password used when creating DB. Default: `masterkey`

Notes
- The tool masks the password when printing the EF connection string for diagnostics, but otherwise you can copy that connection string from the console output to use in subsequent operations with minimal necessary modifications like replacing db name and password.
- Included `metadata.sql` is an example output generated by the tool from db created with `masterscript.sql`.

Tool behavior details
- Domains:
  - Only user-created domains are exported (fields with `rdb$field_name` not starting with `RDB$` and `rdb$system_flag` = 0 or NULL).
  - System-named `RDB$...` fields are not exported as domains.
- Tables:
  - When a column references a `rdb$field_source` that is a user domain (does not start with `RDB$`), the exporter emits the domain name in the `CREATE TABLE`.
  - If the `rdb$field_source` is a system-generated descriptor (names starting with `RDB$...`), the exporter falls back to concrete type mapping (does not emit `RDB$NNN`).
- Procedures:
  - Parameters and `RETURNS` types use the same resolution logic as table columns (prefer user domain; fallback to concrete type mapping for `RDB$...` descriptors).
  - Procedure bodies are wrapped with `SET TERM ^ ;` ... `SET TERM ; ^` and each procedure block ends with `^` so isql can recreate PSQL blocks.
- Any errors results in rollback attempt when applying updates or building DB to preserve data integrity.

Limitations
- Type mapping is intentionally conservative and supports a subset of Firebird types. The mapping in code handles these common types:
  - SMALLINT (type 7)
  - INTEGER (8)
  - QUAD (9)
  - FLOAT (10)
  - D_FLOAT (11)
  - DATE (12), TIME (13), TIMESTAMP (35)
  - CHAR (14) and VARCHAR (37) — exported with `CHAR(n)`/`VARCHAR(n)` and `CHARACTER SET UTF8` (character length preferred when available)
  - NUMERIC / DECIMAL / BIGINT (16) — precision/scale handling is limited (precision > 0 yields `DECIMAL(precision,scale)`), otherwise falls back to `BIGINT` or `DECIMAL(length,0)`
  - DOUBLE PRECISION (27)
  - CSTRING (40)
  - BLOB (261) — `BLOB SUB_TYPE TEXT` when sub-type = 1
- Fallbacks:
  - When a field type is unknown or mapping is not possible, the exporter falls back to `VARCHAR(255) CHARACTER SET UTF8`.
  - The character set for string fallbacks is fixed to `UTF8`.
- Edge cases:
  - Complex domain, tables and procedure definitions (collations, check constraints, user-defined subtypes) are not fully reconstructed — only basic domain, tables and procedure type and default are exported.
  - The exporter assumes presence of standard system metadata columns such as `rdb$system_flag`. If a Firebird variant lacks these columns or behaves differently, results may vary.
- PSQL parsing:
  - The tool uses `FbScript` to split and handle `SET TERM` and procedure blocks. Some provider versions expose parsing differences; the exporter filters out fragments that are not executable standalone (e.g., `DECLARE VARIABLE` fragments) where necessary.
